<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Tevzi İş Atama</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f8f8f8;
    display: flex;
    height: 100vh;
  }

  /* LEFT */
  .left {
    width: 28%;
    background: #ffffff;
    border-right: 1px solid #ddd;
    padding: 16px;
    overflow-y: auto;
  }

  .left h2 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 20px;
  }

  .person-card {
    padding: 12px;
    margin-bottom: 10px;
    background: #f2f6ff;
    border-radius: 8px;
    border-left: 4px solid #4f73ff;
  }

  .time-box {
    font-size: 14px;
    color: #555;
    margin-top: 4px;
  }

  .exit-time {
    color: #d13a3a;
    font-weight: bold;
  }

  /* RIGHT */
  .right {
    width: 72%;
    padding: 20px;
    overflow-y: auto;
  }

  h1 {
    margin-top: 0;
  }

  select, button, input {
    padding: 8px;
    font-size: 14px;
    margin: 4px 0;
  }

  .row {
    display: flex;
    gap: 12px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
    font-size: 14px;
  }

  th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }

  th {
    background: #f1f1f1;
  }

  .assign-btn {
    background: #4f73ff;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
  }

  .assign-btn:hover {
    background: #3f63ee;
  }

</style>
</head>
<body>

<!-- LEFT SIDE -->
<div class="left">
  <h2>Kart Okutan Personeller</h2>
  <div id="scanList">Yükleniyor...</div>
</div>

<!-- RIGHT SIDE -->
<div class="right">
  <h1>Tevzi İş Atama</h1>

  <div class="row">
    <div style="flex: 1;">
      <label>İş / Proje</label><br>
      <select id="jobSelect"></select>
    </div>

    <div>
      <label>İş Başlangıç Saati</label><br>
      <select id="startTime">
        <option>07:00</option>
        <option>08:00</option>
        <option>09:00</option>
        <option>10:00</option>
        <option>11:00</option>
      </select>
    </div>

    <div>
      <label>İş Bitiş Saati</label><br>
      <select id="endTime">
        <option>17:00</option>
        <option>18:00</option>
        <option>19:00</option>
      </select>
    </div>
  </div>

  <button class="assign-btn" onclick="assignJob()">İş Ata</button>
  <button class="assign-btn" style="background:#555" onclick="loadTodayAssignments()">Listeleri Yenile</button>

  <h2>Bugünkü İş Atamaları</h2>
  <table>
    <thead>
      <tr>
        <th>Personel</th>
        <th>Görev</th>
        <th>İş</th>
        <th>Başlangıç</th>
        <th>Bitiş</th>
      </tr>
    </thead>
    <tbody id="assignmentsBody"></tbody>
  </table>
</div>

<script>

// SUNUCU URL
const API = "";

// ------- JOB LIST LOAD -------
async function loadJobs() {
  const res = await fetch(API + "/api/jobs");
  const json = await res.json();
  const sel = document.getElementById("jobSelect");

  sel.innerHTML = "";
  json.data.forEach(job => {
    const opt = document.createElement("option");
    opt.value = job;
    opt.textContent = job;
    sel.appendChild(opt);
  });
}

// ------- LOAD TODAY SCANS (GİRİŞ - ÇIKIŞ) -------
async function loadScans() {
  const res = await fetch(API + "/api/today-scans");
  const json = await res.json();

  const div = document.getElementById("scanList");
  div.innerHTML = "";

  if (json.data.length === 0) {
    div.innerHTML = "Bugün kart okutan personel yok.";
    return;
  }

  json.data.forEach(p => {
    const card = document.createElement("div");
    card.className = "person-card";

    card.innerHTML = `
      <strong>${p.fullName}</strong><br>
      <span>${p.role}</span>
      <div class="time-box">
        ➤ Giriş: <strong>${p.firstScanAt.slice(11,16)}</strong>
      </div>
      <div class="time-box">
        ➤ Çıkış: 
        ${p.hasExit 
          ? `<span class="exit-time">${p.lastScanAt.slice(11,16)}</span>` 
          : `<span style="color:#777">(henüz çıkmadı)</span>`}
      </div>
    `;

    div.appendChild(card);
  });
}

// ------- ASSIGN JOB -------
async function assignJob() {
  const jobName = document.getElementById("jobSelect").value;
  const startTime = `${today()}T${document.getElementById("startTime").value}:00`;
  const endTime = `${today()}T${document.getElementById("endTime").value}:00`;

  // Soldaki ilk adamı otomatik seçiyoruz
  const scanCards = document.querySelectorAll(".person-card");
  if (scanCards.length === 0) {
    alert("Bugün kart okutan kimse yok.");
    return;
  }

  const firstName = scanCards[0].querySelector("strong").innerText;
  const person = await findPersonByName(firstName);

  if (!person) {
    alert("Personel bulunamadı!");
    return;
  }

  const res = await fetch(API + "/api/assign", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      personId: person.id,
      jobName,
      startTime,
      endTime
    })
  });

  const json = await res.json();
  if (!json.ok) {
    alert(json.error);
  } else {
    alert("İş ataması yapıldı!");
    loadTodayAssignments();
  }
}

// ------- FIND PERSON -------
async function findPersonByName(full) {
  const res = await fetch(API + "/api/persons");
  const json = await res.json();

  return json.data.find(p => (p.firstName + " " + p.lastName) === full);
}

// ------- LOAD TODAY ASSIGNMENTS -------
async function loadTodayAssignments() {
  const res = await fetch(API + "/api/assignments/today");
  const json = await res.json();

  const body = document.getElementById("assignmentsBody");
  body.innerHTML = "";

  json.data.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${a.fullName}</td>
      <td>${a.role}</td>
      <td>${a.jobName}</td>
      <td>${a.startTime.slice(11,16)}</td>
      <td>${a.endTime.slice(11,16)}</td>
    `;
    body.appendChild(tr);
  });
}

// TODAY FORMAT
function today() {
  return new Date().toISOString().slice(0,10);
}

// AUTO REFRESH
setInterval(() => loadScans(), 4000);

// INITIAL LOAD
loadJobs();
loadScans();
loadTodayAssignments();

</script>

</body>
</html>
